# Copyright (C) 2025 Red Hat, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: pde2e-podman
  labels:
    app.kubernetes.io/version: "0.1"
    redhat.com/product: podman-desktop
    dev.lifecycle.io/phase: testing
spec:
  description: >-
    This task can setup podman and podman machine on the target host machine

  workspaces:
    - name: pipelines-data
  
  params:
    - name: host
    - name: username
    - name: userpassword
    - name: key
    - name: os
      default: windows
    - name: arch
      default: amd64
    - name: workspace-resources-path
    - name: image-version
      default: '0.0.3'
    - name: download-url
      default: "''"
    - name: podman-version
      default: "''"
    - name: install-wsl
      default: '0'
    - name: podman-initialize
      default: '0'
    - name: podman-start
      default: '0'
    - name: podman-rootful
      default: '0'
    - name: podman-user-networking
      default: '0'
    - name: podman-provider
      default: "''"
    - name: workspace-qe-subpath
      default: qe-results
    - name: results-folder
      default: 'results/podman-location.log'
    - name: target-cleanup
      default: 'true'

  results:
    - name: duration
    - name: results-folder-path
    - name: podman-path

  steps:
    - name: pd-e2e-podman
      image: quay.io/odockal/pde2e-podman:v$(params.image-version)-$(params.os)
      imagePullPolicy: Always
      script: |
        #!/bin/bash
        SECONDS=0
        TARGET_HOST=$(params.host)
        TARGET_HOST_USERNAME=$(params.username)
        TARGET_HOST_KEY_PATH=$(workspaces.pipelines-data.path)/$(params.workspace-resources-path)/$(params.key)
        chmod 600 ${TARGET_HOST_KEY_PATH}
        TARGET_FOLDER=pd-e2e
        TARGET_RESULTS=$(params.results-folder)
        OUTPUT_FOLDER=$(workspaces.pipelines-data.path)/$(params.workspace-resources-path)/$(params.workspace-qe-subpath)
        mkdir -p "${OUTPUT_FOLDER}"
        
        # --- WINDOWS COMMAND CONSTRUCTION ---
        if [[ $(params.os) == "windows" ]]; then
          cmd="${TARGET_FOLDER}/podman.ps1 "
          cmd="$cmd -targetFolder '${TARGET_FOLDER}' "
          cmd="$cmd -resultsFolder '${TARGET_RESULTS}' "
          cmd="$cmd -downloadUrl '$(params.download-url)' "
          
          # FIX: Changed '-version' to '-podmanVersion' to match common script param names
          # and wrapped in quotes to prevent shell expansion errors.
          cmd="$cmd -podmanVersion '$(params.podman-version)' " 
          
          cmd="$cmd -installWSL '$(params.install-wsl)' "
          cmd="$cmd -initialize '$(params.podman-initialize)' "
          cmd="$cmd -start '$(params.podman-start)' "
          cmd="$cmd -rootful '$(params.podman-rootful)' "
          cmd="$cmd -userNetworking '$(params.podman-user-networking)'"
          
          if [[ -n "$(params.podman-provider)" ]] && [[ "$(params.podman-provider)" != "''" ]]; then
            cmd="$cmd -podmanProvider '$(params.podman-provider)' "
          fi
        fi

        # --- DARWIN COMMAND CONSTRUCTION ---
        if [[ $(params.os) == "darwin" ]]; then
          cmd="${TARGET_FOLDER}/podman.sh "
          cmd="$cmd --targetFolder '${TARGET
